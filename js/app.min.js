(function(){for(var c=0,a=["ms","moz","webkit","o"],b=0;b<a.length&&!window.requestAnimationFrame;++b)window.requestAnimationFrame=window[a[b]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[b]+"CancelAnimationFrame"]||window[a[b]+"CancelRequestAnimationFrame"];if(!window.requestAnimationFrame)window.requestAnimationFrame=function(a){var b=(new Date).getTime(),e=Math.max(0,16-(b-c)),j=window.setTimeout(function(){a(b+e)},e);c=b+e;return j};if(!window.cancelAnimationFrame)window.cancelAnimationFrame=
function(a){clearTimeout(a)}})();
var Player=function(c,a){var b={x:c+0.5,y:a+0.5,dx:1,dy:0,cx:0,cy:0.66,speed:0.12,rotspeed:0.1,up:!1,down:!1,right:!1,left:!1};b.init=function(){b.cos_rotspeedp=Math.cos(b.rotspeed);b.cos_rotspeedn=Math.cos(-b.rotspeed);b.sin_rotspeedp=Math.sin(b.rotspeed);b.sin_rotspeedn=Math.sin(-b.rotspeed);document.addEventListener("keydown",b.key_down,!1);document.addEventListener("keyup",b.key_up,!1)};b.update=function(a){var c=b.dx*b.speed,e=b.dy*b.speed;b.up&&(a.is_free(Math.floor(b.x+c),Math.floor(b.y))&&
(b.x+=c),a.is_free(Math.floor(b.x),Math.floor(b.y+e))&&(b.y+=e));b.down&&(a.is_free(Math.floor(b.x-c),Math.floor(b.y))&&(b.x-=c),a.is_free(Math.floor(b.x),Math.floor(b.y-e))&&(b.y-=e));if(b.left)a=b.dx,b.dx=a*b.cos_rotspeedn-b.dy*b.sin_rotspeedn,b.dy=a*b.sin_rotspeedn+b.dy*b.cos_rotspeedn,a=b.cx,b.cx=a*b.cos_rotspeedn-b.cy*b.sin_rotspeedn,b.cy=a*b.sin_rotspeedn+b.cy*b.cos_rotspeedn;if(b.right)a=b.dx,b.dx=a*b.cos_rotspeedp-b.dy*b.sin_rotspeedp,b.dy=a*b.sin_rotspeedp+b.dy*b.cos_rotspeedp,a=b.cx,b.cx=
a*b.cos_rotspeedp-b.cy*b.sin_rotspeedp,b.cy=a*b.sin_rotspeedp+b.cy*b.cos_rotspeedp};b.key_down=function(a){if(37==a.keyCode)b.left=!0;if(39==a.keyCode)b.right=!0;if(38==a.keyCode)b.up=!0;if(40==a.keyCode)b.down=!0};b.key_up=function(a){if(37==a.keyCode)b.left=!1;if(39==a.keyCode)b.right=!1;if(38==a.keyCode)b.up=!1;if(40==a.keyCode)b.down=!1};b.init();return b},Obj=function(c,a,b,m,d){var e={name:c,x:a,y:b,size:m,texture:d};e.distance=function(a,b){return Math.pow(a-e.x,2)+Math.pow(b-e.y,2)};return e},
Objects=function(){var c={textures:[],objs:[]};c.init=function(){var a,b=["img/object.png"];for(a=0;a<b.length;a++)c.textures[a]=new Image,c.textures[a].src=b[a]+"?1"};c.add=function(a,b,m,d,e){c.objs[c.objs.length]=Obj(a,b,m,d,e)};c.remove=function(a){delete c.objs[a]};c.sorted=function(a,b){var m,d=[];for(m in c.objs)d[d.length]={obj:c.objs[m],dist:c.objs[m].distance(a,b)};return d.sort(function(a,b){return b.dist-a.dist})};c.get_texture=function(a){return c.textures[a]};c.init();return c},Map=
function(){var c={UNUSED:-1,FREE:0,BLOCK:1,MOVEABLE:2,name:"Test Dungeon",data:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,0,0,0,1,0,0,0,0,1,1,0,1,1,0,1,1,0,0,1,1,0,0,0,0,0,0,1,0,1,1,0,1,1,0,1,1,0,0,0,0,0,1,1,0,1,0,0,0,1,1,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,1,0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,0,0,0,1,1,1,0,0,0,1,1,0,0,0,0,0,1,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0,1,0,1,0,1,1,1,1,1,0,1,1,1,1,0,0,0,1,1,0,0,0,0,0,1,1,1,1,1,0,0,1,1,1,1,0,1,1,1,0,1,0,1,0,1,1,1,1,1,1,0,0,0,0,0,0,1,1,
1,0,0,0,0,0,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,1,1,0,0,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],automap:[],width:20,height:20,textures:[],bg:void 0,floor0:"rgb(0, 0, 0)",floor1:"rgb(80, 90, 100)",ceiling0:"rgb(0, 0, 0)",
ceiling1:"rgb(80, 80, 80)",objs:Objects()};c.init=function(){var a,b=["","img/wall.jpg"];for(a=0;a<b.length;a++)c.textures[a]=new Image,c.textures[a].src=b[a]+"?1";for(a=0;a<c.width*c.height;a++)c.automap[a]=c.UNUSED;c.bg=new Image;c.bg.src="img/map.jpg?1";c.objs.add("Blue potion",3.5,1.5,0.2,0);c.objs.add("Blue potion",7.5,2.25,0.2,0);c.objs.add("Blue potion",7.5,2.75,0.2,0)};c.texture=function(a){return c.textures[a]};c.get_texture=function(a,b){return c.texture(c.data[b*c.width+a])};c.is_free=
function(a,b){return 0>a||a>=c.width||0>b||b>=c.height?!1:0==c.data[b*c.width+a]};c.record_auto=function(a,b){c.automap[b*c.width+a]=c.data[b*c.width+a]};c.get_auto=function(a,b){return c.automap[b*c.width+a]};c.init();return c},Application=function(c){var a={id:c,canvas:void 0,canvas_ctx:void 0,buffer:void 0,ctx:void 0,map:Map(),player:Player(1,1),show_map:!1,width:512,height:400,_width:512,_height:400,fps:60,_time:Date.now(),_frames:0};a.setup=function(){a.canvas=document.getElementById(a.id);return a.canvas.getContext?
(a.canvas.width=a.width,a.canvas.height=a.height,a.canvas.style.background="rgb(0, 0, 0)",a.buffer=document.createElement("canvas"),a.buffer.width=a._width,a.buffer.height=a._height,a.ctx=a.buffer.getContext("2d"),a.canvas_ctx=a.canvas.getContext("2d"),!0):!1};a.resize=function(){document.webkitFullscreenElement||document.mozFullScreenElement?(a.canvas.style.width=document.width+"px",a.canvas.style.height=document.height+"px"):(a.canvas.style.width="",a.canvas.style.height="")};a.draw=function(){a.ctx.clearRect(0,
0,a.width,a.height);var b=a.ctx.createLinearGradient(0,a._height/2,0,a._height);b.addColorStop(0,a.map.floor0);b.addColorStop(1,a.map.floor1);a.ctx.fillStyle=b;a.ctx.fillRect(0,a._height/2,a._width,a._height/2);b=a.ctx.createLinearGradient(0,0,0,a._height/2);b.addColorStop(1,a.map.ceiling0);b.addColorStop(0,a.map.ceiling1);a.ctx.fillStyle=b;a.ctx.fillRect(0,0,a._width,a._height/2);var c,b=[];for(c=0;c<a._width;c++){var d,e,j,h,g,f,l,o,i,n,k;d=2*c/a._width-1;e=a.player.x;j=a.player.y;h=a.player.dx+
a.player.cx*d;d=a.player.dy+a.player.cy*d;g=Math.floor(e);f=Math.floor(j);l=Math.sqrt(1+d*d/(h*h));o=Math.sqrt(1+h*h/(d*d));0>h?(i=-1,dist_x=(e-g)*l):(i=1,dist_x=(g+1-e)*l);0>d?(n=-1,dist_y=(j-f)*o):(n=1,dist_y=(f+1-j)*o);for(;!(dist_x<dist_y?(dist_x+=l,g+=i,k=!0):(dist_y+=o,f+=n,k=!1),a.map.record_auto(g,f),!a.map.is_free(g,f)););k?(l=(g-e+(1-i)/2)/h,i=j+(g-e+(1-i)/2)/h*d):(l=(f-j+(1-n)/2)/d,i=e+(f-j+(1-n)/2)/d*h);i-=Math.floor(i);0>l&&(l=-l);b[c]=l;e=Math.abs(Math.floor(a._height/l));j=-e/2+a._height/
2;i=Math.floor(i*a.map.get_texture(g,f).width);k&&0<h&&(i=a.map.get_texture(g,f).width-i-1);!k&&0>d&&(i=a.map.get_texture(g,f).width-i-1);d=a.map.get_texture(g,f);a.ctx.drawImage(d,i,0,1,d.height,c,j,1,e);h=1.6*e/a._height;d=Math.round(60/h);d=60-d;0>d&&(d=0);h=1-h;a.ctx.fillStyle="rgba("+d+", "+d+", "+d+", "+h+")";a.ctx.fillRect(c,j,1,e)}h=a.map.objs.sorted(a.player.x,a.player.y);for(k=0;k<h.length;k++){d=h[k].obj.x-a.player.x;g=h[k].obj.y-a.player.y;f=1/(a.player.cx*a.player.dy-a.player.dx*a.player.cy);
c=f*(a.player.dy*d-a.player.dx*g);g=f*(-a.player.cy*d+a.player.cx*g);c=Math.floor(a._width/2*(1+c/g));f=Math.abs(Math.floor(a._height/g))*h[k].obj.size;j=Math.floor(-f/2+a._height/2);0>j&&(j=0);e=Math.floor(-f/2+c);i=0;0>e&&(i=-e,e=0);end_x=Math.floor(f/2+c);end_x>=a._width&&(end_x=a._width-1);for(c=e;c<end_x;c++)0<g&&0<c&&c<a._width&&g<b[c]&&(d=a.map.objs.get_texture(h[k].obj.texture),n=Math.floor((c-e)*d.width/f),a.ctx.drawImage(d,i+n,0,1,d.height,c,j+Math.floor(256/g)-f/2,1,f))}a.canvas_ctx.clearRect(0,
0,a.canvas.width,a.canvas.height);a.canvas_ctx.drawImage(a.buffer,0,0);b=Date.now();a._frames++;a.canvas_ctx.fillStyle="rgb(255, 0, 0)";a.canvas_ctx.fillText("FPS: "+Math.round(1E3*a._frames/(b-a._time)),1,a.height-5);if(b>a._time+1E3*a.fps)a._time=b,a._frames=0};a.draw_map=function(){var b,c;a.ctx.drawImage(a.map.bg,0,0);a.ctx.save();a.ctx.font="bold 20pt MedievalSharp";a.ctx.textAlign="center";a.ctx.fillStyle="rgb(0, 0, 0)";a.ctx.fillText(a.map.name,a._width/2,a._height-20);for(b=0;b<a.map.height;b++)for(c=
0;c<a.map.width;c++)if(a.map.get_auto(c,b)==a.map.BLOCK)a.ctx.fillStyle="rgba(60, 60, 60, 0.5)",a.ctx.fillRect(5+15*c,5+15*b,15,15),a.ctx.strokeStyle="rgb(0, 0, 0)",a.ctx.strokeRect(5+15*c,5+15*b,15,15);else if(a.map.get_auto(c,b)==a.map.MOVEABLE)a.ctx.fillStyle="rgba(60, 0, 120, 0.5)",a.ctx.fillRect(5+15*c,5+15*b,15,15),a.ctx.strokeStyle="rgb(60, 0, 120)",a.ctx.strokeRect(5+15*c,5+15*b,15,15);else if(a.map.get_auto(c,b)==a.map.FREE)a.ctx.fillStyle="rgba(160, 160, 160, 0.5)",a.ctx.fillRect(5+15*c,
5+15*b,15,15);a.ctx.fillStyle="rgb(0, 225, 0)";a.ctx.fillRect(5+15*Math.floor(a.player.x),5+15*Math.floor(a.player.y),15,15);a.ctx.restore();a.canvas_ctx.clearRect(0,0,a.canvas.width,a.canvas.height);a.canvas_ctx.drawImage(a.buffer,0,0)};a.loop=function(){requestAnimationFrame(a.loop);a.player.update(a.map);a.show_map?a.draw_map():a.draw()};a.run=function(){a.setup()&&a.loop()};a.key_down=function(b){if(77==b.keyCode)a.show_map=!0;70==b.keyCode&&(a.canvas.webkitRequestFullScreen?a.canvas.webkitRequestFullScreen(!0):
a.canvas.mozRequestFullScreen?a.canvas.mozRequestFullScreen():a.canvas.requestFullScreen&&a.canvas.requestFullScreen())};a.key_up=function(b){if(77==b.keyCode)a.show_map=!1};a.init=function(){document.addEventListener("keydown",a.key_down,!1);document.addEventListener("keyup",a.key_up,!1);window.onresize=a.resize};a.init();return a};window.onload=function(){Application("myCanvas").run()};
